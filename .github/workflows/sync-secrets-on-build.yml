name: Sync Secrets on Build

on:
  workflow_run:
    workflows: ["*"]
    types:
      - requested
      - in_progress
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync to all devices'
        required: false
        type: boolean
        default: false

jobs:
  sync-to-onprem:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v1
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          METABASE_URL: op://Development/Metabase/url
          METABASE_API_KEY: op://Development/Metabase/api_key
          OP_CONNECT_HOST: op://Development/1Password Connect/host
          OP_CONNECT_TOKEN: op://Development/1Password Connect/token

      - name: Notify on-prem devices
        env:
          ONPREM_WEBHOOK_URLS: ${{ secrets.ONPREM_WEBHOOK_URLS }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          echo "Notifying on-premises devices of build..."

          # Parse webhook URLs (comma-separated)
          IFS=',' read -ra URLS <<< "$ONPREM_WEBHOOK_URLS"

          for url in "${URLS[@]}"; do
            echo "Notifying: $url"

            # Create payload
            PAYLOAD=$(cat <<EOF
          {
            "action": "requested",
            "workflow": {
              "name": "${{ github.workflow }}"
            },
            "repository": {
              "full_name": "${{ github.repository }}"
            },
            "sender": {
              "login": "${{ github.actor }}"
            },
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          )

            # Generate signature
            SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | sed 's/^.* //')

            # Send webhook
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$url" \
              -H "Content-Type: application/json" \
              -H "X-GitHub-Event: workflow_run" \
              -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
              -d "$PAYLOAD")

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n-1)

            if [ "$HTTP_CODE" = "200" ]; then
              echo "✓ Successfully notified: $url"
              echo "$BODY" | jq '.' || echo "$BODY"
            else
              echo "✗ Failed to notify: $url (HTTP $HTTP_CODE)"
              echo "$BODY"
            fi
          done

      - name: Update GitHub secrets cache
        run: |
          echo "Secrets synced at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Workflow: ${{ github.workflow }}"
          echo "Triggered by: ${{ github.actor }}"

  verify-sync:
    needs: sync-to-onprem
    runs-on: ubuntu-latest
    if: github.event.inputs.force_sync == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Check device sync status
        env:
          ONPREM_STATUS_URLS: ${{ secrets.ONPREM_STATUS_URLS }}
        run: |
          echo "Checking sync status of on-premises devices..."

          IFS=',' read -ra URLS <<< "$ONPREM_STATUS_URLS"

          for url in "${URLS[@]}"; do
            echo "Checking: $url"

            STATUS=$(curl -s "$url" || echo '{"error": "unreachable"}')
            echo "$STATUS" | jq '.' || echo "$STATUS"
          done
